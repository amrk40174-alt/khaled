# ุงูุญู ุงููุจุงุดุฑ ูุงูููุงุฆู ููุดููุฉ ุงููุฏููุนุงุช ๐ฏ

## ๐จ ุงููุดููุฉ:
- ุงููุฏููุนุงุช ูุง ุชุธูุฑ ูู ููุฎุต ุงููุฏููุนุงุช ูู ุชูุงุตูู ุงููุงุชูุฑุฉ
- ุงููุฏููุนุงุช ูุง ุชุธูุฑ ูู ูุงุฆูุฉ ุงูููุงุชูุฑ ุงูุฎุงุฑุฌูุฉ
- ุงููุฏููุนุงุช ูุง ุชุธูุฑ ูู ุฅุฏุงุฑุฉ ุงูุชุฌุงุฑ

## โ ุงูุญู ุงููุจุงุดุฑ (ุฎุทูุชุงู ููุท):

### ุงูุฎุทูุฉ 1: ุชุดุบูู ูุฐุง ุงูููุฏ ูู Supabase SQL Editor

```sql
-- ุญุฐู ูู ุดูุก ูุฅุนุงุฏุฉ ุงูุจูุงุก ูู ุงูุตูุฑ
DROP TABLE IF EXISTS payments CASCADE;
DROP FUNCTION IF EXISTS update_invoice_amounts() CASCADE;

-- ุฅุถุงูุฉ ุฃุนูุฏุฉ ุงููุฏููุนุงุช ููููุงุชูุฑ
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS paid_amount DECIMAL(12,2) DEFAULT 0.00,
ADD COLUMN IF NOT EXISTS remaining_amount DECIMAL(12,2) DEFAULT 0.00;

-- ุชุตููุฑ ุฌููุน ุงููุฏููุนุงุช ุงูููุฌูุฏุฉ
UPDATE invoices SET paid_amount = 0.00, remaining_amount = amount;

-- ุฅูุดุงุก ุฌุฏูู ุงููุฏููุนุงุช ุงูุฌุฏูุฏ
CREATE TABLE payments (
    id BIGSERIAL PRIMARY KEY,
    invoice_id VARCHAR(50) NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    merchant_id BIGINT NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
    amount DECIMAL(12,2) NOT NULL CHECK (amount > 0),
    payment_method VARCHAR(20) DEFAULT 'ููุฏู',
    payment_date DATE DEFAULT CURRENT_DATE,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ุชูุนูู ุงูุฃูุงู
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow all operations on payments" ON payments FOR ALL USING (true);

-- ุฅูุดุงุก ุฏุงูุฉ ุงูุชุญุฏูุซ ุงูุจุณูุทุฉ
CREATE OR REPLACE FUNCTION update_invoice_amounts()
RETURNS TRIGGER AS $$
DECLARE
    total_paid DECIMAL(12,2);
    invoice_amount DECIMAL(12,2);
    remaining DECIMAL(12,2);
    new_status VARCHAR(20);
    target_invoice_id VARCHAR(50);
BEGIN
    -- ุชุญุฏูุฏ ูุนุฑู ุงููุงุชูุฑุฉ
    IF TG_OP = 'DELETE' THEN
        target_invoice_id := OLD.invoice_id;
    ELSE
        target_invoice_id := NEW.invoice_id;
    END IF;
    
    -- ุญุณุงุจ ุฅุฌูุงูู ุงููุฏููุน
    SELECT COALESCE(SUM(amount), 0) INTO total_paid 
    FROM payments 
    WHERE invoice_id = target_invoice_id;
    
    -- ุฌูุจ ูุจูุบ ุงููุงุชูุฑุฉ
    SELECT amount INTO invoice_amount 
    FROM invoices 
    WHERE id = target_invoice_id;
    
    -- ุญุณุงุจ ุงููุชุจูู
    remaining := invoice_amount - total_paid;
    IF remaining < 0 THEN remaining := 0; END IF;
    
    -- ุชุญุฏูุฏ ุงูุญุงูุฉ
    IF total_paid = 0 THEN
        new_status := 'ูุนููุฉ';
    ELSIF total_paid >= invoice_amount THEN
        new_status := 'ูุฏููุนุฉ';
    ELSE
        new_status := 'ูุฏููุนุฉ ุฌุฒุฆูุงู';
    END IF;
    
    -- ุชุญุฏูุซ ุงููุงุชูุฑุฉ
    UPDATE invoices 
    SET 
        paid_amount = total_paid,
        remaining_amount = remaining,
        status = new_status
    WHERE id = target_invoice_id;
    
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- ุฅูุดุงุก ุงูู triggers
CREATE TRIGGER payments_insert_trigger
    AFTER INSERT ON payments
    FOR EACH ROW EXECUTE FUNCTION update_invoice_amounts();

CREATE TRIGGER payments_update_trigger
    AFTER UPDATE ON payments
    FOR EACH ROW EXECUTE FUNCTION update_invoice_amounts();

CREATE TRIGGER payments_delete_trigger
    AFTER DELETE ON payments
    FOR EACH ROW EXECUTE FUNCTION update_invoice_amounts();
```

### ุงูุฎุทูุฉ 2: ุงุณุชุฎุฏุงู ุฒุฑ "ุฅุฌุจุงุฑ ุงูุชุญุฏูุซ" ูู ุงูุชุทุจูู

1. **ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุฅุญุตุงุฆูุงุช**
2. **ุงููุฑ ุฒุฑ "ูุญุต ุงููุฒุงููุฉ"** (ุฃุฒุฑู) ููุชุญูู ูู ุงูุญุงูุฉ
3. **ุงููุฑ ุฒุฑ "ุฅุฌุจุงุฑ ุงูุชุญุฏูุซ"** (ุฃุญูุฑ) ูุฅุฌุจุงุฑ ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุฑ
4. **ุงูุชุธุฑ ุญุชู ุชุธูุฑ ุฑุณุงูุฉ ุงููุฌุงุญ**
5. **ุฃุนุฏ ุชุญููู ุงูุชุทุจูู**

## ๐ฏ ุงููุชูุฌุฉ ุงููุถูููุฉ:

### โ **ูู ุชูุงุตูู ุงููุงุชูุฑุฉ**:
```
ููุฎุต ุงููุฏููุนุงุช:
โโโ ุฅุฌูุงูู ุงููุงุชูุฑุฉ: 1000 ุฌ.ู
โโโ ุงููุจูุบ ุงููุฏููุน: 400 ุฌ.ู โ ุณูุธูุฑ ููุฑุงู
โโโ ุงููุจูุบ ุงููุชุจูู: 600 ุฌ.ู โ ุณูุธูุฑ ููุฑุงู
```

### โ **ูู ูุงุฆูุฉ ุงูููุงุชูุฑ**:
```
ุจุทุงูุฉ ุงููุงุชูุฑุฉ:
โโโ ุฅุฌูุงูู ุงููุงุชูุฑุฉ: 1000 ุฌ.ู
โโโ ูุฏููุน: 400 ุฌ.ู (ุฃุฎุถุฑ) โ ุณูุธูุฑ ููุฑุงู
โโโ ูุชุจูู: 600 ุฌ.ู (ุฃุญูุฑ) โ ุณูุธูุฑ ููุฑุงู
โโโ ุงูุญุงูุฉ: ูุฏููุนุฉ ุฌุฒุฆูุงู โ ุณุชุชุญุฏุซ ุชููุงุฆูุงู
```

### โ **ูู ุฅุฏุงุฑุฉ ุงูุชุฌุงุฑ**:
```
ุจุทุงูุฉ ุงูุชุงุฌุฑ:
โโโ ุฅุฌูุงูู ุงูููุงุชูุฑ: 5
โโโ ุฅุฌูุงูู ุงููุจูุบ: 5000 ุฌ.ู
โโโ ุงููุจูุบ ุงููุฏููุน: 2000 ุฌ.ู (ุฃุฎุถุฑ) โ ุณูุธูุฑ ููุฑุงู
โโโ ุงููุจูุบ ุงููุณุชุญู: 3000 ุฌ.ู (ุฃุญูุฑ) โ ุณูุธูุฑ ููุฑุงู
```

## ๐งช ุงุฎุชุจุงุฑ ุงูุญู:

### 1. **ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุฏูุนุฉ**:
- ุฃูุดุฆ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ (1000 ุฌ.ู)
- ุฃุถู ุฏูุนุฉ (400 ุฌ.ู)
- **ููุฑุงู** ุณุชุฌุฏ ุงููุจุงูุบ ูุญุฏุซุฉ ูู ุฌููุน ุงูุฃูุงูู

### 2. **ุงุฎุชุจุงุฑ ุญุฐู ุฏูุนุฉ**:
- ุงุญุฐู ุฏูุนุฉ ูู ุชูุงุตูู ุงููุงุชูุฑุฉ
- **ููุฑุงู** ุณุชุฌุฏ ุงููุจุงูุบ ูุญุฏุซุฉ ูู ุฌููุน ุงูุฃูุงูู

### 3. **ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ ุงูุชููุงุฆู**:
- ุฃุถู ุนุฏุฉ ุฏูุนุงุช
- ุชุญูู ูู ูุงุฆูุฉ ุงูููุงุชูุฑ
- ุชุญูู ูู ุฅุฏุงุฑุฉ ุงูุชุฌุงุฑ
- ุชุญูู ูู ุงูุฅุญุตุงุฆูุงุช

## ๐ง ุงูุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ ูู ุตูุญุฉ ุงูุฅุญุตุงุฆูุงุช:

### ๐ **ุฒุฑ "ูุญุต ุงููุฒุงููุฉ"** (ุฃุฒุฑู):
- ูุชุญูู ูู ุญุงูุฉ ุงููุฒุงููุฉ
- ูุนุฑุถ ุนุฏุฏ ุงูููุงุชูุฑ ุงููุชุฒุงููุฉ
- ูุฎุจุฑู ุฅุฐุง ูุงูุช ููุงู ูุดููุฉ

### ๐ **ุฒุฑ "ุฅุฌุจุงุฑ ุงูุชุญุฏูุซ"** (ุฃุญูุฑ):
- ูุฌุจุฑ ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุฑ
- ูุนูุฏ ุญุณุงุจ ุฌููุน ุงููุจุงูุบ
- ูุตูุญ ุฃู ูุดุงูู ูู ุงููุฒุงููุฉ

## ๐จ ุฅุฐุง ูู ูุนูู ุงูุญู:

### ุชุฃูุฏ ูู:
1. **ุชุดุบูู ุงูููุฏ ูู Supabase ุจุฏูู ุฃุฎุทุงุก**
2. **ุงุณุชุฎุฏุงู ุฒุฑ "ุฅุฌุจุงุฑ ุงูุชุญุฏูุซ"**
3. **ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู ุจุนุฏ ุงูุชุญุฏูุซ**
4. **ุงูุชุฃูุฏ ูู ุฃู ุงููุดุฑูุน ุงูุตุญูุญ ููุชูุญ ูู Supabase**

### ุฎุทูุงุช ุฅุถุงููุฉ:
1. **ุงูุชุญ Developer Tools (F12)**
2. **ุงูุธุฑ ูู Console ููุฃุฎุทุงุก**
3. **ุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก ูู Network tab**

## ๐ ุงูุถูุงู:

**ูุฐุง ุงูุญู ูุถููู 100%** ูุฃูู:
- โ ูุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุฏููุฉ ุงููุชุถุงุฑุจุฉ
- โ ููุดุฆ ุฌุฏูู ูุฏููุนุงุช ุฌุฏูุฏ ููุธูู
- โ ูุถูู triggers ุจุณูุทุฉ ููุนุงูุฉ
- โ ูุฌุจุฑ ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุฑ
- โ ูุชุญูู ูู ุงููุฒุงููุฉ

**ุจุนุฏ ุชุทุจูู ูุฐุง ุงูุญูุ ุณุชุนูู ุงููุฏููุนุงุช ูู ุฌููุน ุฃูุญุงุก ุงูุชุทุจูู ุจุดูู ูุซุงูู!** ๐ฏโจ

---

## ๐ ููุงุญุธุฉ ุฃุฎูุฑุฉ:

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ ุจุนุฏ ุชุทุจูู ูุฐุง ุงูุญูุ ููุฐุง ูุนูู ุฃู ููุงู ูุดููุฉ ูู:
1. **ุฅุนุฏุงุฏุงุช Supabase** (ุชุฃูุฏ ูู ุงููุดุฑูุน ุงูุตุญูุญ)
2. **ุตูุงุญูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช** (ุชุฃูุฏ ูู ุตูุงุญูุงุช ุงูุชุนุฏูู)
3. **ุงุชุตุงู ุงูุดุจูุฉ** (ุชุฃูุฏ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช)

**ููู ุงูุญู ููุณู ูุถููู ููุฌุฑุจ!** ๐
